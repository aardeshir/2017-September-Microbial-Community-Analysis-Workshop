---
title: "Microbial Community Analysis workshop"
output: 
  md_document:
    variant: markdown_github
---

# Using the Phyloseq package

## installation from bioconductor
```{r}
#source("http://bioconductor.org/biocLite.R")
#biocLite("phyloseq")
library(phyloseq)
library(ggplot2)
library(gridExtra)

```

## Read in the dataset, biom file generated from dbcAmplicons pipeline
```{r}
slashpile_16sV1V3 <- "16sV1V3.biom"
s16sV1V3 = import_biom(BIOMfilename = slashpile_16sV1V3, parseFunction = parse_taxonomy_default)
colnames(tax_table(s16sV1V3)) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")
rank_names(s16sV1V3)
# sample_variables(GlobalPatterns)
sample_variables(s16sV1V3)
# [1] "Depth_cm"          "Dist_from_edge"    "Slash_pile_number" "primers" 
s16sV1V3
```

## Filtering

Lets generate a prevelance table for each taxa
```{r}
prevelancedf = apply(X = otu_table(s16sV1V3),
                 MARGIN = 1,
                 FUN = function(x){sum(x > 0)})
# Add taxonomy and total read counts to this data.frame
prevelancedf = data.frame(Prevalence = prevelancedf,
                      TotalAbundance = taxa_sums(s16sV1V3),
                      tax_table(s16sV1V3))
prevelancedf[1:10,]
```

The following ensures that features with ambiguous phylum annotation are also removed.

```{r}
s16sV1V3.1 <- subset_taxa(s16sV1V3, !is.na(Phylum) & !Phylum %in% c("", "uncharacterized"))
s16sV1V3.1
```

### Now subset low occurance taxa

```{r}
plyr::ddply(prevelancedf, "Phylum", function(df1){
  data.frame(mean_prevalence=mean(df1$Prevalence),mean_abundance=mean(df1$TotalAbundance,na.rm = T),stringsAsFactors = F)
  })
```

### Define phyla to filter
```{r}
phyla2Filter = c("p__Aquificae", "p__candidate division ZB3",
  "p__Crenarchaeota","p__Deinococcus-Thermus","p__Omnitrophica","p__Tenericutes","p__Thermodesulfobacteria")
# Filter entries with unidentified Phylum.
s16sV1V3.2 = subset_taxa(s16sV1V3.1, !Phylum %in% phyla2Filter)
s16sV1V3.2
```

### Subset to the remaining phyla
```{r}
prevelancedf1 = subset(prevelancedf, Phylum %in% get_taxa_unique(s16sV1V3.2, taxonomic.rank = "Phylum"))
ggplot(prevelancedf1, aes(TotalAbundance, Prevalence / nsamples(s16sV1V3.2),color=Phylum)) +
  # Include a guess for parameter
  geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) + geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() +  xlab("Total Abundance") + ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Phylum) + theme(legend.position="none")
```

```{r}
#  Define prevalence threshold as 10% of total samples
prevalenceThreshold = 0.10 * nsamples(s16sV1V3.2)
prevalenceThreshold

# Execute prevalence filter, using `prune_taxa()` function
keepTaxa = rownames(prevelancedf1)[(prevelancedf1$Prevalence >= prevalenceThreshold)]
s16sV1V3.3 = prune_taxa(keepTaxa, s16sV1V3.2)
s16sV1V3.3
```

### Agglomerate taxa and remove all taxa with not at the genus level
```{r}
prop  = transform_sample_counts(s16sV1V3.3, function(x) x / sum(x) )
keepTaxa <- ((apply(otu_table(prop) >= 0.005,1,sum,na.rm=TRUE) > 2) | (apply(otu_table(prop) >= 0.05, 1, sum,na.rm=TRUE) > 0))
table(keepTaxa)
s16sV1V3.4 <- prune_taxa(keepTaxa,s16sV1V3.3)

length(get_taxa_unique(s16sV1V3.4, taxonomic.rank = "Genus"))
s16sV1V3.4 = tax_glom(s16sV1V3.4, "Genus", NArm = TRUE)
s16sV1V3.4
```

```{r}
plot_abundance = function(physeq,title = "",
			     Facet = "Order", Color = "Phylum"){
  # Arbitrary subset, based on Phylum, for plotting
  p1f = subset_taxa(physeq, Phylum %in% c("p__Firmicutes"))
  mphyseq = psmelt(p1f)
  mphyseq <- subset(mphyseq, Abundance > 0)
  ggplot(data = mphyseq, mapping = aes_string(x = "Slash_pile_number",y = "Abundance",
                                 color = Color, fill = Color)) +
    geom_violin(fill = NA) +
    geom_point(size = 1, alpha = 0.3,
                position = position_jitter(width = 0.3)) +
    facet_wrap(facets = Facet) + scale_y_log10()+
    theme(legend.position="none")
}

s16sV1V3.4ra = transform_sample_counts(s16sV1V3.4, function(x){x / sum(x)})

plotBefore = plot_abundance(s16sV1V3.4,"before")
plotAfter = plot_abundance(s16sV1V3.4ra,"after")
# Combine each plot into one graphic.
grid.arrange(nrow = 2, plotBefore, plotAfter)


```

```{r}
qplot(log10(colSums(otu_table(s16sV1V3.4))),bins=30) +
  xlab("Logged counts-per-sample")
s16sV1V3.4 <- prune_samples(sample_sums(s16sV1V3.4)>=10000, s16sV1V3.4)
```

```{r}
s16sV1V3.4log <- transform_sample_counts(s16sV1V3.4, function(x) log(1 + x))
out.pcoa.log <- ordinate(s16sV1V3.4log, method = "PCoA", distance = "bray")
evals <- out.pcoa.log$values$Eigenvalues
plot_ordination(s16sV1V3.4, out.pcoa.log, type = "samples", 
                color = "Slash_pile_number", shape = "Depth_cm") + labs(col = "Slash pile number") +
  coord_fixed(sqrt(evals[2] / evals[1]))
```

```{r}
plot_ordination(s16sV1V3.4log, out.pcoa.log, type = "species", color = "Phylum") +
  coord_fixed(sqrt(evals[2] / evals[1]))

```

```{r}
prop <- t(apply(otu_table(s16sV1V3.4log), 1, function(x) x / sum(x)))

grid.arrange(nrow = 2,
qplot(prop[, "Slashpile18"], geom = "histogram", bins=30) +
  xlab("Relative abundance"),

qplot(prop[, "Slashpile10"], geom = "histogram", bins=30) +
  xlab("Relative abundance")
)
s16sV1V3.4 <- prune_samples(sample_names(s16sV1V3.4) != "Slashpile18", s16sV1V3.4)
```

## Graphical Summary

```{r}
s16sV1V3.4_acidob = subset_taxa(s16sV1V3.4, Phylum=="p__Acidobacteria")
title = "plot_bar; Acidobacteria-only"
plot_bar(s16sV1V3.4_acidob, "Slash_pile_number", "Abundance", "Family", title=title)

plot_heatmap(s16sV1V3.4, "PCoA", distance="bray", sample.label="Slash_pile_number", taxa.label="Genus", low="#FFFFCC", high="#000033", na.value="white")

plot_net(s16sV1V3.4, maxdist=0.4, color="Slash_pile_number", shape="Depth_cm")

colorScale    <- rainbow(length(levels(as.factor(get_variable(s16sV1V3.4, "Slash_pile_number")))))
cols          <- colorScale[as.factor(get_variable(s16sV1V3.4, "Slash_pile_number"))] 
GP.tip.labels <- as(get_variable(s16sV1V3.4, "Slash_pile_number"), "character")
# This is the actual hierarchical clustering call, specifying average-link clustering
d <- distance(s16sV1V3.4, method="bray", type="samples")
GP.hclust     <- hclust(d, method="average")
plot(GP.hclust, col=cols)
```

## Differntial Abundances
```{r}
library("edgeR")

m = as(otu_table(s16sV1V3.4), "matrix")
# Add one to protect against overflow, log(0) issues.
m = m + 1
# Define gene annotations (`genes`) as tax_table
taxonomy = tax_table(s16sV1V3.4, errorIfNULL=FALSE)
if( !is.null(taxonomy) ){
  taxonomy = data.frame(as(taxonomy, "matrix"))
} 
# Now turn into a DGEList
d = DGEList(counts=m, genes=taxonomy, remove.zeros = TRUE)

# Calculate the normalization factors
z = calcNormFactors(d, method="TMM")
# Check for division by zero inside `calcNormFactors`
if( !all(is.finite(z$samples$norm.factors)) ){
  stop("Something wrong with edgeR::calcNormFactors on this data,
       non-finite $norm.factors, consider changing `method` argument")
}
plotMDS(z, col = as.numeric(factor(sample_data(s16sV1V3.4)$Slash_pile_number)), labels = sample_names(s16sV1V3.4))

mm <- model.matrix(~ 0 + Slash_pile_number, data=data.frame(as(sample_data(s16sV1V3.4),"matrix"))) # specify model with no intercept for easier contrasts
mm
y <- voom(d, mm, plot = T)

fit <- lmFit(y, mm)
head(coef(fit))

# Comparison between cultivars C and I5 at time 6
contr <- makeContrasts(Slash_pile_number2 - Slash_pile_number1,
                       Slash_pile_number3 - Slash_pile_number1,
                       Slash_pile_number3 - Slash_pile_number2,
                       levels = colnames(coef(fit)))
tmp <- contrasts.fit(fit, contr)
tmp <- eBayes(tmp)
tmp2 <- topTable(tmp, coef=1, sort.by = "P", n = Inf)
tmp2$Taxa <- rownames(tmp2)
tmp2 <- tmp2[,c("Taxa","logFC","AveExpr","P.Value","adj.P.Val")]
length(which(tmp2$adj.P.Val < 0.05)) # number of DE genes
# 0
sigtab = cbind(as(tmp2, "data.frame"), as(tax_table(s16sV1V3.4)[rownames(tmp2), ], "matrix"))

theme_set(theme_bw())
scale_fill_discrete <- function(palname = "Set1", ...) {
    scale_fill_brewer(palette = palname, ...)
}
sigtabgen = subset(sigtab, !is.na(Genus))
# Phylum order
x = tapply(sigtabgen$logFC, sigtabgen$Phylum, function(x) max(x))
x = sort(x, TRUE)
sigtabgen$Phylum = factor(as.character(sigtabgen$Phylum), levels = names(x))
# Genus order
x = tapply(sigtabgen$logFC, sigtabgen$Genus, function(x) max(x))
x = sort(x, TRUE)
sigtabgen$Genus = factor(as.character(sigtabgen$Genus), levels = names(x))
ggplot(sigtabgen, aes(x = Genus, y = logFC, color = Phylum)) + geom_point(size=6) + 
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5))

```
